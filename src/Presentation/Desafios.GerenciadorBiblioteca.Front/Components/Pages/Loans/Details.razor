@page "/loans/details/{Id:int}"
@using System.ComponentModel.DataAnnotations
@using Desafios.GerenciadorBiblioteca.Service.CQRS.Loans.Commands.UpdateLoan
@using Desafios.GerenciadorBiblioteca.Service.DTOs
@using Desafios.GerenciadorBiblioteca.Website.Components.Pages.Loans.Custom.Panels
@using Desafios.GerenciadorBiblioteca.Website.Services
@inject HttpService httpService
@inject AlertService alertService

<PageTitle>Empréstimo</PageTitle>

<MudText Typo="Typo.h5" GutterBottom="true">Detalhes do Empréstimo</MudText>

<MudContainer Class="d-flex flex-row align-center pa-0 mt-5 mb-5 ma-0 gap-5 w-100" MaxWidth="MaxWidth.False">
    <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors" Class="d-flex flex-row align-start pa-0 ma-0 gap-5 w-100">
        <MudSelect T="int" Label="Livro" AnchorOrigin="Origin.BottomCenter"
                   HelperText="@helperTextBooks" Class="mb-2"
                   Validation="@(new Func<int, string>(ValidateBook))" Required="true"
                   RequiredError="O Livro é obrigatório" @bind-Value="loan.InventoryId">
            <MudSelectItem Value="0">Selecione um livro</MudSelectItem>
            @foreach (var b in inventoriesDictionary)
            {
                <MudSelectItem Value="b.Key">@b.Value</MudSelectItem>
            }
        </MudSelect>

        <MudSelect T="int" Label="Usuário" AnchorOrigin="Origin.BottomCenter"
                   HelperText="@helperTextUsers"
                   Validation="@(new Func<int, string>(ValidateUser))" Required="true"
                   RequiredError="O Usuário é obrigatório" @bind-Value="loan.UserId">
            <MudSelectItem Value="0">Selecione um usuário</MudSelectItem>
            @foreach (var u in usersDictionary)
            {
                <MudSelectItem Value="u.Key">@u.Value</MudSelectItem>
            }
        </MudSelect>

        <MudDatePicker ShowToolbar="false" Label="Data empréstimo"
                       HelperText="A Data de Empréstimo deve ser menor ou igual a Data Atual"
                       Validation="@(new Func<DateTime?, string>(ValidateLoanDate))" Required="true"
                       @bind-Date="loanDate" />

        <MudDatePicker ShowToolbar="false" Label="Data Validade"
                       HelperText="A Data de Validade dever ser pelo menos 1 dia maior do que a Data de Empréstimo"
                       Validation="@(new Func<DateTime?, string>(ValidateLoanValidity))" Required="true"
                       @bind-Date="loanValidity" />

        <MudSelect T="bool" Label="Status" AnchorOrigin="Origin.BottomCenter" Required="true"
                   RequiredError="O Status é obrigatório" @bind-Value="loan.Returned">
            <MudSelectItem Value="true">Devolvido</MudSelectItem>
            <MudSelectItem Value="false">Pendente</MudSelectItem>
        </MudSelect>
    </MudForm>

    <MudButton Variant="Variant.Filled" Color="Color.Tertiary" StartIcon="@Icons.Material.Filled.Save" @onclick="EditLoanAsync">Salvar</MudButton>
</MudContainer>

<MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Class="h-100 mh-100 w-100 mw-100" PanelClass="pa-6 h-100 mh-100 overflow-y-auto">
    <MudTabPanel Text="Histórico" Class="h-100 w-100">
        <CustomUsersPanel Id="Id" />
    </MudTabPanel>
</MudTabs>

@code {
    [Parameter]
    public int Id { get; set; }

    public Loan loan = new();

    private Dictionary<int, string> inventoriesDictionary = new();
    private Dictionary<int, string> usersDictionary = new();

    private DateTime? loanDate = DateTime.Now;
    private DateTime? loanValidity = DateTime.Now.AddDays(1).AddHours(1);

    private string helperTextBooks = string.Empty;
    private string helperTextUsers = string.Empty;

    private MudForm form;
    private bool success;
    private string[] errors = [];

    protected override async Task OnInitializedAsync()
    {
        await InitializeLoanAsync();
        await InitializeDictionariesAsync();
        SetHelperTexts();
    }

    private void SetHelperTexts()
    {
        helperTextBooks = "Se o livro não estiver listado, adicione-o à nossa base de dados na aba \"Livros\".";
        helperTextUsers = "Se o Usuário não estiver listado, adicione-o à nossa base de dados na aba \"Usuários\".";
    }

    private async Task EditLoanAsync()
    {
        await form.Validate();

        if (form.IsValid)
        {
            UpdateLoanCommand body = new(Id, loan.InventoryId, loan.UserId, loanDate.Value, loanValidity.Value);
            var result = await httpService.PutAsync<UpdateLoanCommand, CustomResponse<Loan>>($"/api/Loans/{Id}", body);

            if (result.IsSuccess)
                loan = result.Content.Data;
            else
                alertService.ShowErrors(result.ErrorDetails, result.StatusCode);
        }
    }

    private string ValidateBook(int bookId)
    {
        return bookId <= 0 ? "O Livro é obrigatório" : null;
    }

    private string ValidateUser(int userId)
    {
        return userId <= 0 ? "O Usuário é obrigatório" : null;
    }

    private string ValidateLoanDate(DateTime? loanDate)
    {
        if (loanDate == null)
            return "A Data de Empréstimo é obrigatória";

        return loanDate > DateTime.Now ? "Data de Empréstimo inválida. Selecione uma data menor ou igual à data atual." : null;
    }

    private string ValidateLoanValidity(DateTime? loanValidity)
    {
        if (loanValidity == null)
            return "A Data de Validade é obrigatória";

        return loanValidity < loanDate?.AddDays(1) ? "Data de Validade inválida. Intervalo entre a Data de Empréstimo e a Data de Validade deve ser de no mínimo 1 dia." : null;
    }

    private async Task InitializeLoanAsync()
    {
        var result = await httpService.GetAsync<CustomResponse<Loan>>($"/api/Libraries/{Id}");

        if (result.IsSuccess)
            loan = result.Content.Data;
        else
            alertService.ShowErrors(result.ErrorDetails, result.StatusCode);
    }

    private async Task InitializeDictionariesAsync()
    {
        await InitializeBooksDictAsync();
        await InitializeUsersDictAsync();
    }

    private async Task InitializeBooksDictAsync()
    {
        var result = await httpService.GetAsync<CustomResponse<Dictionary<int, string>>>($"/api/Inventories/library/{Id}/books/dict");

        if (result.IsSuccess)
            inventoriesDictionary = result.Content.Data;
        else
        {
            alertService.ShowErrors(result.ErrorDetails, result.StatusCode);
            inventoriesDictionary = [];
        }
    }

    private async Task InitializeUsersDictAsync()
    {
        var result = await httpService.GetAsync<CustomResponse<Dictionary<int, string>>>($"/api/Users/dict");

        if (result.IsSuccess)
            usersDictionary = result.Content.Data;
        else
        {
            alertService.ShowErrors(result.ErrorDetails, result.StatusCode);
            usersDictionary = [];
        }
    }
}
